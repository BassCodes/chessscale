(()=>{"use strict";function e(e,t){return"number"==typeof t?[e[0]+t,e[1]+t]:[e[0]+t[0],e[1]+t[1]]}function t(e,t){return"number"==typeof t?[e[0]*t,e[1]*t]:[e[0]*t[0],e[1]*t[1]]}function i(e){if(null==e)throw new TypeError("Unwrap called on null/undefined value");return e}function s(e,t){if(null==e)throw new TypeError(t);return e}Math.PI,Math.PI,Math.PI;class o{static slice(e,t){const s=i(document.createElement("canvas"));s.style.display="none",[s.width,s.height]=t,document.body.appendChild(s);const o=i(s.getContext("2d")),n=[],r=e.width/t[0],c=e.height/t[1];for(let i=0;i<c;i++)for(let c=0;c<r;c++){o.drawImage(e,-c*t[0],-i*t[1]);const r=new Image(...t);r.src=s.toDataURL(),o.clearRect(0,0,...t),n.push(r)}return s.remove(),n}}const n={pieces:[],initialized:!1,init(){return e=this,t=void 0,s=function*(){if(this.initialized)throw new Error("Cannot load textures twice...");this.pieces=o.slice(yield new Promise(((e,t)=>{const i=new Image;i.addEventListener("load",(()=>e(i)),{once:!0}),i.addEventListener("error",(e=>{t(e)}),{once:!0}),i.src="./chess_sprites.png"})),[64,64]),this.initialized=!0},new((i=void 0)||(i=Promise))((function(o,n){function r(e){try{h(s.next(e))}catch(e){n(e)}}function c(e){try{h(s.throw(e))}catch(e){n(e)}}function h(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}h((s=s.apply(e,t||[])).next())}));var e,t,i,s}};var r;!function(e){e[e.White=0]="White",e[e.Black=1]="Black"}(r||(r={}));class c{constructor(e){this.color=e}getImage(){throw new Error("unimplemented")}getMoves(){throw new Error("unimplemented")}getCaptures(){return this.getMoves()}}class h extends c{constructor(){super(...arguments),this.firstMove=!0}getMoves(){const e=[this.color===r.White?[0,-1]:[0,1]];return this.firstMove&&e.push(this.color===r.White?[0,-2]:[0,2]),e}getCaptures(){return this.color===r.White?[[-1,-1],[1,-1]]:[[-1,1],[1,1]]}getImage(){return this.color===r.White?n.pieces[5]:n.pieces[11]}}const l=[[1,1],[1,0],[1,-1],[0,1],[0,-1],[-1,1],[-1,0],[-1,-1]],a=[[-1,-1],[-2,-2],[-3,-3],[-4,-4],[-5,-5],[-6,-6],[-7,-7],[-8,-8],[1,-1],[2,-2],[3,-3],[4,-4],[5,-5],[6,-6],[7,-7],[8,-8],[-1,1],[-2,2],[-3,3],[-4,4],[-5,5],[-6,6],[-7,7],[-8,8],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8]],d=[[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[-1,0],[-2,0],[-3,0],[-4,0],[-5,0],[-6,0],[-7,0],[-8,0],[0,-1],[0,-2],[0,-3],[0,-4],[0,-5],[0,-6],[0,-7],[0,-8],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8]],u=[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]],w=[];w.push(...d),w.push(...a);class p extends c{getMoves(){return l}getImage(){return this.color===r.White?n.pieces[0]:n.pieces[6]}}class f extends c{getMoves(){return w}getImage(){return this.color===r.White?n.pieces[1]:n.pieces[7]}}class v extends c{getMoves(){return d}getImage(){return this.color===r.White?n.pieces[4]:n.pieces[10]}}class g extends c{getMoves(){return a}getImage(){return this.color===r.White?n.pieces[2]:n.pieces[8]}}class P extends c{getMoves(){return u}getImage(){return this.color===r.White?n.pieces[3]:n.pieces[9]}}class m{constructor(e){this.distance=512,this.lookAt=[256,256],this.ctx=e,this.fieldOfView=Math.PI/4,this.viewport={left:0,right:0,top:0,bottom:0,width:0,height:0,scale:[1,1]},this.aspectRatio=e.canvas.width/e.canvas.height,this.init()}init(){this.addListeners(),this.updateViewport()}begin(){this.ctx.save(),this.applyScale(),this.applyTranslation()}end(){this.ctx.restore()}applyScale(){this.ctx.scale(this.viewport.scale[0],this.viewport.scale[1])}applyTranslation(){this.ctx.translate(-this.viewport.left,-this.viewport.top)}updateViewport(){this.aspectRatio=this.ctx.canvas.width/this.ctx.canvas.height,this.viewport.width=this.distance*Math.tan(this.fieldOfView),this.viewport.height=this.viewport.width/this.aspectRatio,this.viewport.left=this.lookAt[0]-this.viewport.width/2,this.viewport.top=this.lookAt[1]-this.viewport.height/2,this.viewport.right=this.viewport.left+this.viewport.width,this.viewport.bottom=this.viewport.top+this.viewport.height,this.viewport.scale[0]=this.ctx.canvas.width/this.viewport.width,this.viewport.scale[1]=this.ctx.canvas.height/this.viewport.height}zoomTo(e){this.distance=e,this.updateViewport()}moveTo(e,t){this.lookAt[0]=e,this.lookAt[1]=t,this.updateViewport()}screenToWorld(e,t){return[e/this.viewport.scale[0]+this.viewport.left,t/this.viewport.scale[1]+this.viewport.top]}worldToScreen(e,t){return[(e-this.viewport.left)*this.viewport.scale[0],(t-this.viewport.top)*this.viewport.scale[1]]}addListeners(){let e=!1,t=!1;window.addEventListener("mousedown",(i=>{0===i.button?e=!0:2===i.button&&(t=!0)})),window.addEventListener("mouseup",(i=>{0===i.button?e=!1:2===i.button&&(t=!1)})),window.addEventListener("mousemove",(i=>{if(i.shiftKey&&e||t){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,1e5,1e5);const[e,t]=this.lookAt;this.moveTo(e-i.movementX*this.distance/512,t-i.movementY*this.distance/512)}})),window.onwheel=e=>{this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,1e5,1e5);let t=this.distance+2*e.deltaY;t<=1&&(t=1),this.zoomTo(t)}}}const b=64;class k{constructor(){this.selectedPosition=null,this.selectedPiece=null}clickBoard(t,i,s,o){const n=[Math.floor(t/b),Math.floor(i/b)];if("up"===o&&null===this.selectedPosition)return this.selectedPosition=null,void(this.selectedPiece=null);if("down"===o&&this.selectedPiece===s.getPiece(...n))return this.selectedPosition=null,void(this.selectedPiece=null);if("down"===o&&null!==s.getPiece(...n))return this.selectedPosition=n,void(this.selectedPiece=s.getPiece(...n));if(null!==this.selectedPiece&&null!==this.selectedPosition){for(const t of this.selectedPiece.getMoves()){const i=e(t,this.selectedPosition);if(c=n,(r=i)[0]===c[0]&&r[1]===c[1])return s.setPiece(...i,this.selectedPiece),s.setPiece(...this.selectedPosition,null),this.selectedPiece instanceof h&&(this.selectedPiece.firstMove=!1),this.selectedPosition=null,void(this.selectedPiece=null)}var r,c;"up"!==o&&(this.selectedPosition=null,this.selectedPosition=null)}}drawMovements(i,s){if(null===this.selectedPosition)return;i.ctx.lineWidth=2;const o=s.getPiece(...this.selectedPosition);if(null==o)throw new Error("unreachable code executed");i.ctx.strokeStyle="green";for(const s of o.getMoves()){const o=e(this.selectedPosition,s);i.ctx.fillStyle="rgba(140,140,140,0.6)",i.ctx.beginPath(),i.ctx.arc(...e(t(o,b),32),b/6,0,2*Math.PI),i.ctx.fill()}i.ctx.strokeStyle="red",i.ctx.strokeRect(...t(this.selectedPosition,b),b,b)}}class x{constructor(e,t){this.chunkCoordinate=[e,t],this.tiles=Array(8),this.discovered=Array(8);for(let e=0;e<8;e++)this.tiles[e]=Array(8).fill(null),this.discovered[e]=Array(8).fill(!0)}discoverAll(){this.discovered=!0}}class y{constructor(){this.chunks=[];for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)this.generateChunk(e,t)}drawPieces(i){for(const s of this.chunks)for(const[o,n]of s.tiles.entries())for(const[r,c]of n.entries()){if(null===c)continue;const n=[o,r];i.ctx.drawImage(c.getImage(),...t(e(n,t(s.chunkCoordinate,8)),b))}}drawChunks(e){for(const t of this.chunks)for(let i=0;i<8;i++)for(let s=0;s<8;s++)e.ctx.fillStyle=(i+s)%2==0?"#b4955f":"#805833",e.ctx.fillRect((i+8*t.chunkCoordinate[0])*b,(s+8*t.chunkCoordinate[1])*b,b,b)}drawChunkBorders(e){e.ctx.lineWidth=3,e.ctx.strokeStyle="green";for(const i of this.chunks)e.ctx.strokeRect(...t(i.chunkCoordinate,512),512,512)}generateChunk(e,t){if(null!==this.getChunk(e,t))throw new Error(`Chunk already generated at (${e}, ${t})`);const i=new x(e,t);return this.chunks.push(i),i}getChunk(e,t){const i=this.chunks.find((i=>i.chunkCoordinate[0]===e&&i.chunkCoordinate[1]===t));return void 0===i?null:i}getPiece(e,t){const i=this.getChunk(Math.floor(e/8),Math.floor(t/8));return null===i?null:(e<0&&(e=8-Math.abs(e)%8),t<0&&(t=8-Math.abs(t)%8),i.tiles[e%8][t%8])}setPiece(e,t,i){const s=[Math.floor(e/8),Math.floor(t/8)];let o=this.getChunk(...s);return null===o&&(o=this.generateChunk(...s)),e<0&&(e=8-Math.abs(e)%8),t<0&&(t=8-Math.abs(t)%8),o.tiles[e%8][t%8]=i,!0}}class M{constructor(){this.board=new y}}window.debug={cborders:!1,toggleBorders(){this.cborders=!this.cborders}},document.addEventListener("DOMContentLoaded",(function(){return e=this,t=void 0,o=function*(){const{canvas:e,ctx:t}=s(function(e,t){const i=document.createElement("canvas");if(i.width=512,i.height=512,null===i)return null;const s=i.getContext("2d");return null===s?null:{canvas:i,ctx:s}}(),"Could not create playfield canvas");s(document.getElementById("pfcontainer"),"Could not insert playfield canvas into DOM").appendChild(e),e.oncontextmenu=e=>{e.preventDefault()},yield n.init();const i=new m(t),o=new k,c=new M;for(let e=0;e<8;e++)c.board.setPiece(e,6,new h(r.White));for(let e=0;e<8;e++)c.board.setPiece(e,1,new h(r.Black));c.board.setPiece(0,7,new v(r.White)),c.board.setPiece(7,7,new v(r.White)),c.board.setPiece(6,7,new P(r.White)),c.board.setPiece(1,7,new P(r.White)),c.board.setPiece(2,7,new g(r.White)),c.board.setPiece(5,7,new g(r.White)),c.board.setPiece(4,7,new p(r.White)),c.board.setPiece(3,7,new f(r.White)),c.board.setPiece(0,0,new v(r.Black)),c.board.setPiece(7,0,new v(r.Black)),c.board.setPiece(6,0,new P(r.Black)),c.board.setPiece(1,0,new P(r.Black)),c.board.setPiece(2,0,new g(r.Black)),c.board.setPiece(5,0,new g(r.Black)),c.board.setPiece(4,0,new p(r.Black)),c.board.setPiece(3,0,new f(r.Black)),e.addEventListener("mousedown",(e=>{o.clickBoard(...i.screenToWorld(e.x,e.y),c.board,"down")})),e.addEventListener("mouseup",(e=>{o.clickBoard(...i.screenToWorld(e.x,e.y),c.board,"up")})),requestAnimationFrame((function e(){i.begin(),c.board.drawChunks(i),window.debug.cborders&&c.board.drawChunkBorders(i),c.board.drawPieces(i),o.drawMovements(i,c.board),i.end(),requestAnimationFrame(e)}))},new((i=void 0)||(i=Promise))((function(s,n){function r(e){try{h(o.next(e))}catch(e){n(e)}}function c(e){try{h(o.throw(e))}catch(e){n(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,c)}h((o=o.apply(e,t||[])).next())}));var e,t,i,o}))})();